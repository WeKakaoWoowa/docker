### 3장 컨테이너 실전 구축 및 배포

1. 애플리케이션과 시스탬 내 단일 컨테이너의 적정 비중

   + 모든 애플리케이션 프로세스 1개를 1개의 컨테이너로 만드는 방법은 오히려 수행하려는 작업의 복잡도를 높일 수 있다. 따라서 '1 프로세스 1 컨테이너'를 고수하는 것보다는 컨테이너는 자신이  맡은 역할을 잘 수행할 수 있도록 1개 또는 그 이상의 프로세스를 실행하도록 해야 한다.

   + 컨테이너는 하나의 관심사에만 집중해야 한다. 여기서 말하는 하나의 관심사란 한 가지 역할 또는 문제 영역(도메인)이다. 

2. 컨테이너의 이식성

   + 도커의 장점 중 하나인 '이식성'은 모든 상황에서 적용되지 않는다. 이식성이 적용되지 않는 경우는 아래와 같다.

   1. 커널 및 아키텍처 차이
      + 컨테이너형 가상화 기술은 호스트 운영 체제와 리소스를 공유하기 때문에 도커 컨테이너를 실행하기 위해서 호스트는 특정 CPU 아키텍쳐 혹은 운영 체제를 사용해야 한다.
   2. 라이브러리와 동적 링크 문제
      + 정적 링크와 동적 링크
        + 정적 링크란 애플리케이션에서 사용된 라이브러리를 애플리케이션 내부에 포함하는 형태이다. 이식성은 뛰어나지만, 애플리케이션의 크기가 비대해진다는 단점이 있다.
        + 동적 링크란 애플리케이션을 실행할 때 라이브러리를 링크하는 형태이다. 애플리케이션의 크기는 작지만, 애플리케이션을 실행할 호스트에서 라이브러리를 갖추어야 한다는 단점이 있다.
      + 동적 링크를 사용하는 애플리케이션을 도커에서 사용하는 경우 애플리케이션에서 사용하는 라이브러리의 버전 불일치 문제로 애플리케이션이 동작하지 않을 수 있다. 따라서 도커 컨테이너에서 실행할 애플리케이션은 라이브러리를 정적 링크하거나 따로 애플리케이션 빌드용 컨테이너를 사용하는 것이 좋다. 또, 도커에서 제시한 multi-stage builds를 이용하는 방법도 있다.

3. 도커 친화적인 애플리케이션

   + 일반적으로 애플리케이션은 만들어둔 옵션에 따라 애플리케이션의 동작을 제어함으로써 재사용성과 유연성을 높인다. 도커 컨테이너 형태로 실행되는 애플리케이션의 동작을 제어하는 방법은 아래와 같다.
     + 실행 시 인자 전달하는 방법
     + 설정 파일을 바꿔가며 사용하는 방법
     + 애플리케이션의 동작을 환경 변수로 제어하는 방법
     + 설정 파일에 환경 변수를 포함하는 방법

4. 퍼시스턴스 데이터를 다루는 방법

   + 도커 컨테이너가 실행 중에 작성하거나 수정한 파일은 호스트에 마운트되지 않는 한 컨테이너가 파기될 때 호스트에서 함께 삭제된다. 파일이나 디렉터리를 수정하고 이용하는, 즉 상태를 갖는 애플리케이션을 도커 컨테이너를 사용해 운영하기 위해선 이전 버전 컨테이너에서 사용하던 파일/디렉터리를 그대로 이어받을 수 있도록 해야 한다.
   + 데이터 볼륨(data volume)
     + 데이터 볼륨이란 도커 컨테이너 안의 디렉터리를 디스크에 퍼시스턴스 데이터로 남기기 위한 매커니즘이다. 호스트와 컨테이너 사이의 디렉터리 공유 및 재사용 기능을 제공하며, 컨테이너를 파기해도 데이터 볼륨은 디스크에 남아있기 때문에 상태를 갖는 애플리케이션을 실행하는 데 적합하다.
     + 데이터 볼륨 사용법
       + 호스트에서 컨테이너에 생성된 파일을 참조하는 방법
       + 데이터 볼륨 컨테이너를 생성해 컨테이너 간에 파일/디렉터리를 공유하는 방법
   
5. 컨테이너 배치 전략

   + 도커 스웜
     + 여러 도커 호스트를 클러스터로 묶어주는 컨테이너 오케스트레이션 도구 중 하나이다. 여러 호스트에 나누어져 있는 여러 컨테이너를 관리하는 것이 주요 목적이다. 
   + 서비스
     + 도커 스웜에서 애플리케이션을 구성하는 컨테이너를 제어하기 위해 사용되는 것이다.
     +  서비스를 통해서 레플리카 수(컨테이너 수)를 조절하며 쉽게 스케일 아웃을 할 수 있다.
     + 스웜 클러스터 외부에서 스웜에 배포된 서비스를 사용하려면 서비스에 트래픽을 분산시키기 위한 프록시를 갖춰야 한다.
   + 스택
     + 도커 스웜에서 하나 이상의 서비스를 그룹으로 묶은 단위이다.
     + 스택을 사용해 여러 서비스를 함께 다루며, 애플리케이션 전체 구성을 정의할 수 있다.
     + overlay 네트워크
       + 여러 도커 호스트에 걸쳐 배포된 컨테이너 그룹을 같은 네트워크에 배치하기 위한 기술이다.
       + 스택에서 overlay 네트워크를 설정하지 않으면 스택마다 서로 다른 overlay 네트워크를 생성하기 때문에 다른 overlay 네트워크에 속한 서비스끼리 통신할 수 없다. 따라서 overlay  네트워크를 구성한 후, 각 스택의 서비스를 해당 네트워크에 소속시켜야 한다.